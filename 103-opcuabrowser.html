<!--
 *
 * Copyright 2015 Valmet Automation Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->

<!--
 NodeRed node that will actually just use server side ./public/address.txt file to select opc ua variable.
 Simplified code and example flow to test functionality.

 @author <a href="mailto:mika.karaila@valmet.com">Mika Karaila</a> (Valmet Automation Inc.)
-->

<script type="text/x-red" data-template-name="OpcUaBrowserEndpoint">
    <div class="form-row">
        <label for="node-config-input-endpoint"><i class="icon-link"></i> Endpoint</label>
        <input type="text" id="node-config-input-endpoint">
    </div>
    <div class="form-row">
        <label for="node-config-input-sign"><i class="icon-key"></i> Sign</label>
        <select type="text" id="node-input-sign">
            <option value="None">None</option>
            <option value="Basic128Rsa15Signed">Basic128Rsa15 signed</option>
            <option value="Basic256Signed">Basic256 signed</option>
            <option value="Basic128Rsa15">Basic128Rsa15 signed+crypted</option>
            <option value="Basic256Signed">Basic256 signed+crypted</option>
        </select>
    </div>
    <div class="form-row">
        <lable><input type="checkbox" id="node-config-input-login" > use credentials</lable>
    </div>
    <div class="form-row node-input-useAuth-row">
        <label for="node-config-input-user"><i class="icon-user"></i> User</label>
        <input type="text" id="node-config-input-user">
    </div>
    <div class="form-row node-input-useAuth-row">
        <label for="node-config-input-password"><i class="icon-password"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>





</script>

<script type="text/x-red" data-template-name="OpcUaBrowser">
    <div class="form-row" style="min-width:640px">
        <label for="node-input-endpoint"><i class="icon-bookmark"></i> Endpoint</label>
        <input type="text" id="node-input-endpoint">
        <button type="button" id="node-input-browsebtn" class="btn"><i class="icon-search"></i></button>
    </div>
    <div class="form-tips node-input-info" id="node-input-item" style="margin-top:5px">
        <div id="node-input-item-text">Now you should able to select an Item.</div>
    </div>
    <div class="form-error node-input-error" id="node-input-erroritem" style="margin-top:5px">
        <div id="node-input-error-text">You are'nt able to select an Item. Update OPC UA settings!</div>
    </div>
    <div class="form-row" id="node-input-item-row">
        <label for="node-input-item"><i class="icon-tag"></i> Item</label>
        <select type="text" id="node-input-item" style="display: inline-block; vertical-align: middle; width:60%;">
            <option selected disabled value="" >Choose a Item</option>
        </select>
    </div>
        <div class="form-row" id="node-input-datatype-row">
        <label for="node-input-datatype"><i class="icon-tag"></i> Type</label>
        <select type="text" id="node-input-datatype" style="display: inline-block; vertical-align: middle; width:60%;">
            <option selected disabled value="" >Choose a Type</option>
            <option value="Integer">Integer</option>
            <option value="Float">Float</option>
            <option selected value="Double">Double</option>
            <option value="UInt16">unsigned Int16</option>
            <option value="Boolean">Boolean</option>
            <option value="String">String</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="icon-search"></i> Topic</label>
        <input type="text" id="node-input-topic">
    </div>


</script>

<script type="text/x-red" data-help-name="OpcUaBrowser">
    <p>Connect to endpoint: opc.tcp://host:port/UA/EndpointName.</p>
    <p>Item can be defined in input msg object:</p>
    <p><b>topic</b> contains OPC UA address and 
    <p><b>datatype></b> contains valid OPC UA type.</p>
    <p>If <b>payload</b> is empty value will be read from the OPC UA server otherwise value will be written to the server.</p>



</script>

<script type="text/javascript">
    RED.nodes.registerType('OpcUaBrowserEndpoint', {
        category: 'config',
        defaults: {
            endpoint: {value: "", required: true},
            login: {value: false}
        },
        credentials: {
            user: {type: "text"},
            password: {type: "password"}
        },
        label: function () {
            return this.endpoint;
        },
        oneditprepare: function () {
            try {
                var loginCheckbox = $("#node-config-input-login");
                var authRow = $(".node-input-useAuth-row");

                if (this.login) {
                    loginCheckbox.prop('checked', true);
                    authRow.show();
                } else {
                    loginCheckbox.prop('checked', false);
                    authRow.hide();
                }

                loginCheckbox.change(function () {
                    if ($(this).is(":checked")) {
                        authRow.show();
                    } else {
                        authRow.hide();
                        $('#node-input-user').val('');
                        $('#node-input-password').val('');
                    }
                });

            } catch (err) {
                console.log(err);
            }
            finally {
                console.log("finally");
            }
        }
    });
</script>

<script type="text/javascript">

    RED.nodes.registerType('OpcUaBrowser', {
        category: 'advanced-function',
        color: "#3FADB5",
        defaults: {
            endpoint: {value: "", required: true, type: "OpcUaBrowserEndpoint"},
            item: {value: ""},
            datatype: {value: ""},
            topic: {value: ""},
            items: {value: []}
        },
        inputs: 1,
        outputs: 1,
        align: "right",
        icon: "arrow-in.png",
        label: function () {
            return this.item || "OPC UA Browser";
        },
        labelStyle: function () {
            return this.item ? "node_label_italic" : "";
        },
        onpaletteadd: function () {

        },
        oneditprepare: function () {
            try {
                var node = this;

                var inputEndpoint = $('#node-input-endpoint');
                var inputItem = $("#node-input-item");

                if (!node.items.length) {
                    $('.node-input-info').hide();
                }
                else {
                    $('.node-input-info').show();
                }

                $('.node-input-error').hide();

                inputItem.append('<option selected disabled value="">Choose a Item</option>\n');

                $('#node-input-item-text').append(' Items: ' + node.items.length);

                function setupClient(callback) {
                    node.items.forEach(function (item) {
                        inputItem.append(item);
                    });
                    callback();
                }

                $('#node-input-browsebtn').click(function () {
                    check_endpoint();
                });

                function check_endpoint() {
                    var url = inputEndpoint.val();

                    if (url) {
                        setupClient(function (err) {
                            if (!err) {
                                $('.node-input-info').show();
                                $('.node-input-error').hide();
                            } else {
                                $('.node-input-info').hide();
                                $('.node-input-error').show();
                            }
                        });
                    }
                    else {
                        $('.node-input-error').show();
                    }
                }
            } catch (err) {
                console.log(err);
            }
            finally {
                console.log("finally");
            }
        }
    });
</script>


